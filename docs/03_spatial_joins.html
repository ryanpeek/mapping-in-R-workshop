<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>spatial joins with sf</title>

<script src="site_libs/header-attrs-2.11/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />
<link rel="stylesheet" href="site_libs_extra/academicons-1.8.0/css/academicons.css"/>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

.sourceCode .row {
  width: 100%;
}
.sourceCode {
  overflow-x: auto;
}
.code-folding-btn {
  margin-right: -30px;
}
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<link rel="stylesheet" href="style.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}

.tocify-subheader {
  display: inline;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
}

</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home fa-2x"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-vector-square"></span>
     
    Vector Data
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="01_vector_shapefiles.html">Working with shapefiles</a>
    </li>
    <li>
      <a href="01_vector_gpx.html">Working with gpx</a>
    </li>
    <li>
      <a href="01_vector_kml.html">Working with kml</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-database fa-1x"></span>
     
    Import/Export
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="02_import_export_gpkg.html">Data Storage with geopackage</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-magic fa-1x"></span>
     
    Spatial Sorcery
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="03_spatial_joins.html">Spatial Joins</a>
    </li>
    <li>
      <a href="03_vig_snapping_points_to_line.html">Snapping Points to Lines</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-map-marked-alt fa-1x"></span>
     
    Mapping Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="04_vig_mapview_leaflet.html">
        <span class="fa fa-globe-americas fa-1x"></span>
         
        Mapview &amp; Leaflet
      </a>
    </li>
    <li>
      <a href="04_vig_making_inset_maps.html">Making Inset Maps</a>
    </li>
    <li>
      <a href="04_vig_workflow_in_R_snowdata.html">Maps with Backgrounds</a>
    </li>
    <li>
      <a href="04_vig_dataRetrieval_for_waterdata.html">
        <span class="fa fa-tint fa-1x"></span>
         
        Working with Water Data
      </a>
    </li>
  </ul>
</li>
<li>
  <a href="00_mapmaking_aesthetics.html">
    <span class="fa fa-palette fa-1x"></span>
     
    Map Aesthetics
  </a>
</li>
<li>
  <a href="00_resources.html">Resources</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="00_contact.html">
    <span class="fa fa-info-circle fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/ryanpeek/mapping-in-R-workshop">
    <span class="fa fa-github fa-1x"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>




</div>


<p><br></p>
<div id="spatial-joins-in-r-with-sf" class="section level2">
<h2>Spatial Joins in R with <code>sf</code></h2>
<p>Some of the most common and useful geospatial operations are <strong>joins</strong> based on some component of the spatial topology. For example, you want to figure out what attributes of certain points that are associated with or within certain polygons on the landscape…like bus-stops in a county or river gaging stations within a watershed.</p>
<p>Spatial joins are based on the intersection between two spatial objects, often points and the polygons. There are many ways we can join objects, which may include <a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">specific options</a> like <em>crosses</em>,<em>near</em>, <em>within</em>, <em>touches</em>, etc. The point being, we can do all this in R! Robin Lovelace et al. have a great online book available: <a href="https://geocompr.robinlovelace.net/spatial-operations.html" class="uri">https://geocompr.robinlovelace.net/spatial-operations.html</a> that covers some of this material. Check it out!</p>
<p>Let’s <strong>load the libraries</strong> we’re going to need first.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(USAboundaries)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnaturalearth)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(GSODR)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggrepel)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cowplot)</span></code></pre></div>
<div id="polygon-data" class="section level3">
<h3>Polygon Data</h3>
<p>We’ll be using California and CA counties pulled from the <code>USAboundaries</code> package.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get USA states, filter out Puerto Rico, Alaska, and Hawaii for now</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>us <span class="ot">&lt;-</span> <span class="fu">us_states</span>(<span class="at">resolution =</span> <span class="st">&quot;low&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>state_abbr <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;PR&quot;</span>, <span class="st">&quot;AK&quot;</span>, <span class="st">&quot;HI&quot;</span>))</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># get CA boundary with high definition</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>ca <span class="ot">&lt;-</span> USAboundaries<span class="sc">::</span><span class="fu">us_states</span>(<span class="at">resolution =</span> <span class="st">&quot;high&quot;</span>, <span class="at">states =</span> <span class="st">&quot;CA&quot;</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># make a box around CA (a grid with an n=1) for inset</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>ca_box <span class="ot">&lt;-</span> <span class="fu">st_make_grid</span>(ca, <span class="at">n =</span> <span class="dv">1</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># get CA county boundary</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>ca_co <span class="ot">&lt;-</span> USAboundaries<span class="sc">::</span><span class="fu">us_counties</span>(<span class="at">resolution =</span> <span class="st">&quot;high&quot;</span>, <span class="at">states =</span> <span class="st">&quot;CA&quot;</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure we have all the pieces with a quick test plot</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(us<span class="sc">$</span>geometry)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ca<span class="sc">$</span>geometry, <span class="at">add=</span>T, <span class="at">col=</span><span class="st">&quot;gray50&quot;</span>, <span class="at">border=</span><span class="st">&quot;maroon&quot;</span>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ca_co<span class="sc">$</span>geometry, <span class="at">add=</span>T, <span class="at">border=</span><span class="st">&quot;pink&quot;</span>, <span class="at">col=</span><span class="cn">NA</span>)</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ca_box, <span class="at">add=</span>T, <span class="at">border=</span><span class="st">&quot;red3&quot;</span>, <span class="at">col=</span><span class="cn">NA</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span></code></pre></div>
<p><img src="03_spatial_joins_files/figure-html/getBoundaryDat-1.png" width="672" /></p>
<p><br></p>
</div>
<div id="point-data" class="section level3">
<h3>Point Data</h3>
<p>Now we have some polygon data to work with…let’s add some climate data and practice joining polygons to points and points to polygons! First let’s use the <a href="https://ropensci.github.io/GSODR/"><code>GSODR</code> (Global Surface Summary of the Day) package</a> to get global climate station locations. Then we can join to a few specific states/counties, and plot. First the GSOD data:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load the station metadata file from GSODR (this loads `isd_history` in your</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># R session)</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;isd_history.rda&quot;</span>, <span class="at">package =</span> <span class="st">&quot;GSODR&quot;</span>))</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># make spatial</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>isd_history <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(isd_history) <span class="sc">%&gt;%</span> </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords=</span><span class="fu">c</span>(<span class="st">&quot;LON&quot;</span>,<span class="st">&quot;LAT&quot;</span>), <span class="at">crs=</span><span class="dv">4326</span>, <span class="at">remove=</span><span class="cn">FALSE</span>)  </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># filter to US and CA, many sites out in buoys along coast</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>isd_history_ca <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(isd_history, CTRY<span class="sc">==</span><span class="st">&quot;US&quot;</span>, STATE<span class="sc">==</span><span class="st">&quot;CA&quot;</span>)</span></code></pre></div>
<p>Note, this is a fairly large set of point data, with <code>28,104</code> observations globally. Let’s map this so we can see how dense this dataset actually is. Let’s use a nice set of global maps from the <code>rnaturalearth</code> package. Because the points are so dense, let’s plot those first, then we’ll add a layer of world country outlines.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># view!</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnaturalearth)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnaturalearthdata)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>world <span class="ot">&lt;-</span> <span class="fu">ne_countries</span>(<span class="at">scale =</span> <span class="st">&quot;medium&quot;</span>, <span class="at">returnclass =</span> <span class="st">&quot;sf&quot;</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(isd_history<span class="sc">$</span>geometry, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">cex=</span><span class="fl">0.2</span>, <span class="at">col=</span><span class="st">&quot;gray50&quot;</span>)</span></code></pre></div>
<pre><code>## old-style crs object detected; please recreate object with a recent sf::st_crs()
## old-style crs object detected; please recreate object with a recent sf::st_crs()
## old-style crs object detected; please recreate object with a recent sf::st_crs()</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(world<span class="sc">$</span>geometry, <span class="at">add=</span>T)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="st">&quot;GSOD Climate Stations&quot;</span>)</span></code></pre></div>
<p><img src="03_spatial_joins_files/figure-html/plotGSODR-1.png" width="672" /></p>
<p>That’s a lot of points! Let’s look at just California to make this a little more manageable.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># look at CA sites only</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(isd_history_ca<span class="sc">$</span>geometry, <span class="at">cex=</span><span class="fl">0.5</span>)</span></code></pre></div>
<pre><code>## old-style crs object detected; please recreate object with a recent sf::st_crs()
## old-style crs object detected; please recreate object with a recent sf::st_crs()
## old-style crs object detected; please recreate object with a recent sf::st_crs()</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ca<span class="sc">$</span>geometry, <span class="at">col=</span><span class="fu">alpha</span>(<span class="st">&quot;gray&quot;</span>, <span class="fl">0.5</span>), <span class="at">border=</span><span class="st">&quot;#440154FF&quot;</span>, <span class="at">lwd=</span><span class="fl">1.5</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(isd_history_ca<span class="sc">$</span>geometry, <span class="at">add=</span>T, <span class="at">pch=</span><span class="dv">21</span>, <span class="at">bg=</span><span class="st">&quot;#21908CFF&quot;</span>, <span class="at">cex=</span><span class="fl">0.7</span>, <span class="at">col=</span><span class="st">&quot;black&quot;</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="st">&quot;GSOD Climate Stations labeled as CA&quot;</span>)</span></code></pre></div>
<p><img src="03_spatial_joins_files/figure-html/tstPlotCAISD-1.png" width="672" /></p>
<p>Great, now we have a dataframe in our environment that has both global climate station locations, and only stations associated with California, USA. You’ll notice there are a number of stations that fall outside of the CA border, largely those associated with buoys along the coast.</p>
<hr>
</div>
</div>
<div id="spatial-joins" class="section level2">
<h2>Spatial Joins</h2>
<div id="select-polygons-containing-points" class="section level3">
<h3>Select <em>POLYGONS</em> containing <em>POINTS</em></h3>
<p>This first approach only selects polygons that contain points. For demonstration sake, let’s use the larger global point dataset. Note this does not modify the polygon dataframe in any form (i.e., add attributes, update, summarize, etc). It is only selecting or <em>filtering</em> to the polygons that contain points using a spatial join.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get CA county POLYGONS only that contain ISD points within county boundaries</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># does not bring attributes from points forward</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>ca_co_isd_poly <span class="ot">&lt;-</span> ca_co[isd_history, ]</span></code></pre></div>
<pre><code>## old-style crs object detected; please recreate object with a recent sf::st_crs()
## old-style crs object detected; please recreate object with a recent sf::st_crs()
## old-style crs object detected; please recreate object with a recent sf::st_crs()
## old-style crs object detected; please recreate object with a recent sf::st_crs()</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ca_co_isd_poly<span class="sc">$</span>geometry, <span class="at">col=</span><span class="fu">alpha</span>(<span class="st">&quot;blue&quot;</span>,<span class="fl">0.3</span>))</span></code></pre></div>
<p><img src="03_spatial_joins_files/figure-html/polyptJoin-1.png" width="672" /></p>
</div>
<div id="anti-join-non-matching-objects" class="section level3">
<h3>Anti-Join Non-Matching Objects</h3>
<p>So most counties have at least one point present. What if we specifically wanted to find the counties that <em>don’t</em> have a climate GSOD station in them? We can use something called an “<code>anti_join</code>”, which does precisely that, it identifies the items that don’t have a match. There’s a few possible ways to do this, but the most flexible I’ve found is using the following, because it’s easy to return whatever spatial object you prefer (e.g., points, polygons, lines).</p>
<p>The key is to use the same subsetting <code>[ ]</code> option, but add the <code>!lengths()</code> function to return a logical vector of all the <em>non-matching</em> objects. We are essentially filtering by this vector, so this doesn’t actually add any data from one layer to the other, it simply filters where there aren’t any overlapping bits.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Find ISD points DON&#39;T within county boundaries</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>ca_co_poly_anti <span class="ot">&lt;-</span> isd_history_ca[<span class="sc">!</span><span class="fu">lengths</span>(<span class="fu">st_intersects</span>(isd_history_ca, ca_co)), ]</span></code></pre></div>
<pre><code>## old-style crs object detected; please recreate object with a recent sf::st_crs()
## old-style crs object detected; please recreate object with a recent sf::st_crs()
## old-style crs object detected; please recreate object with a recent sf::st_crs()
## old-style crs object detected; please recreate object with a recent sf::st_crs()
## old-style crs object detected; please recreate object with a recent sf::st_crs()
## old-style crs object detected; please recreate object with a recent sf::st_crs()
## old-style crs object detected; please recreate object with a recent sf::st_crs()
## old-style crs object detected; please recreate object with a recent sf::st_crs()</code></pre>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Find Counties that don&#39;t contain ISD points</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>ca_co_poly_anti2 <span class="ot">&lt;-</span> ca_co[<span class="sc">!</span><span class="fu">lengths</span>(<span class="fu">st_intersects</span>(ca_co, isd_history_ca)), ]</span></code></pre></div>
<pre><code>## old-style crs object detected; please recreate object with a recent sf::st_crs()
## old-style crs object detected; please recreate object with a recent sf::st_crs()
## old-style crs object detected; please recreate object with a recent sf::st_crs()
## old-style crs object detected; please recreate object with a recent sf::st_crs()</code></pre>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot it!</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ca_co<span class="sc">$</span>geometry, <span class="at">col=</span><span class="fu">alpha</span>(<span class="st">&quot;pink&quot;</span>,<span class="fl">0.3</span>))</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ca_co_poly_anti<span class="sc">$</span>geometry, <span class="at">pch=</span><span class="dv">15</span>, <span class="at">add=</span>T, <span class="at">col=</span><span class="st">&quot;maroon&quot;</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ca_co_poly_anti2<span class="sc">$</span>geometry, <span class="at">add=</span>T, <span class="at">col=</span><span class="st">&quot;darkgreen&quot;</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span>(<span class="st">&quot;Anti-joins with CA GSOD Climate Stations:</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="st">Points outside of county boundaries (squares),</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="st">      Counties with no stations (green)&quot;</span>)</span></code></pre></div>
<p><img src="03_spatial_joins_files/figure-html/polyptAntiJoin-1.png" width="672" /></p>
<p><br></p>
</div>
<div id="join-attributes-points-inside-polygons" class="section level3">
<h3>Join Attributes: <em>POINTS</em> inside <em>POLYGONS</em></h3>
<p>Great, what about joining the data attributes? Let’s look for points that fall within CA counties, and add ATTRIBUTES from the county polygons to the climate station points. Just a reminder, here’s the data columns (or <em>attributes</em>) in the polygon dataset:</p>
<pre><code>##    statefp countyfp countyns       affgeoid geoid       name          namelsad stusps state_name lsad       aland     awater state_name state_abbr
## 81      06      025 00277277 0500000US06025 06025   Imperial   Imperial County     CA California   06 10814595262  790216761 California         CA
## 82      06      087 00277308 0500000US06087 06087 Santa Cruz Santa Cruz County     CA California   06  1152823584  419714230 California         CA
## 83      06      097 01657246 0500000US06097 06097     Sonoma     Sonoma County     CA California   06  4080862341  498084088 California         CA
## 84      06      045 00277287 0500000US06045 06045  Mendocino  Mendocino County     CA California   06  9082632466  961740401 California         CA
## 85      06      023 01681908 0500000US06023 06023   Humboldt   Humboldt County     CA California   06  9241565229 1253726036 California         CA
## 86      06      057 01682927 0500000US06057 06057     Nevada     Nevada County     CA California   06  2480587302   41531993 California         CA
##    jurisdiction_type                       geometry
## 81             state MULTIPOLYGON (((-116.1062 3...
## 82             state MULTIPOLYGON (((-122.3177 3...
## 83             state MULTIPOLYGON (((-123.5331 3...
## 84             state MULTIPOLYGON (((-124.0233 4...
## 85             state MULTIPOLYGON (((-124.4086 4...
## 86             state MULTIPOLYGON (((-121.2797 3...</code></pre>
<p><br></p>
<p>So in this case, let’s say we want to add the county <strong><code>name</code></strong> attribute to our POINT dataset, which looks like this (notice there’s no <code>county</code> field or <code>name</code> field):</p>
<pre><code>## old-style crs object detected; please recreate object with a recent sf::st_crs()</code></pre>
<pre><code>##     USAF  WBAN            STN_NAME CTRY STATE CALL    LAT    LON ELEV_M    BEGIN      END        STNID ELEV_M_SRTM_90m              geometry
## 1 008268 99999           WXPOD8278   AF  &lt;NA&gt; &lt;NA&gt; 32.950 65.567 1156.7 20100519 20120323 008268-99999            1160  POINT (65.567 32.95)
## 2 010010 99999 JAN MAYEN(NOR-NAVY)   NO  &lt;NA&gt; ENJA 70.933 -8.667    9.0 19310101 20190115 010010-99999              NA POINT (-8.667 70.933)
## 3 010014 99999          SORSTOKKEN   NO  &lt;NA&gt; ENSO 59.792  5.341   48.8 19861120 20190115 010014-99999              48  POINT (5.341 59.792)
## 4 010015 99999          BRINGELAND   NO  &lt;NA&gt; &lt;NA&gt; 61.383  5.867  327.0 19870117 20081231 010015-99999              NA  POINT (5.867 61.383)
## 5 010016 99999         RORVIK/RYUM   NO  &lt;NA&gt; &lt;NA&gt; 64.850 11.233   14.0 19870116 19910806 010016-99999              NA  POINT (11.233 64.85)
## 6 010017 99999               FRIGG   NO  &lt;NA&gt; ENFR 59.980  2.250   48.0 19880320 20050228 010017-99999              48    POINT (2.25 59.98)</code></pre>
<p><br></p>
<p>So to spatially join the county <code>name</code> attribute with the appropriate point locations, let’s use <code>st_join</code>. If we use <code>left=TRUE</code> here, our result will retain <em>all</em> the points in the dataset rather than just the the spatial overlaps (where points fall inside polygons). So <code>left=TRUE</code> is essentially a <code>dplyr::left_join</code>, and <code>left=FALSE</code> is equivalent to a <code>dplyr::inner_join</code>.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For POINTS that fall within CA_counties, adds ATTRIBUTES, retains ALL pts if left=TRUE, otherwise uses inner_join</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>isd_ca_co_pts <span class="ot">&lt;-</span> <span class="fu">st_join</span>(isd_history, <span class="at">left =</span> <span class="cn">FALSE</span>, ca_co[<span class="st">&quot;name&quot;</span>]) <span class="co"># join points</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(isd_ca_co_pts<span class="sc">$</span>geometry, <span class="at">pch=</span><span class="dv">21</span>, <span class="at">cex=</span><span class="fl">0.7</span>, <span class="at">col=</span><span class="st">&quot;purple&quot;</span>, <span class="at">bg=</span><span class="st">&quot;gray80&quot;</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ca_co<span class="sc">$</span>geometry, <span class="at">border=</span><span class="st">&quot;gray20&quot;</span>, <span class="at">col=</span><span class="cn">NA</span>, <span class="at">add=</span>T)</span></code></pre></div>
<p><img src="03_spatial_joins_files/figure-html/polyJoinAttribs-1.png" width="672" /></p>
<pre><code>##         USAF  WBAN                     STN_NAME CTRY STATE CALL    LAT      LON ELEV_M    BEGIN      END        STNID ELEV_M_SRTM_90m           name
## 13545 690020 93218 JOLON HUNTER LIGGETT MIL RES   US    CA KHGT 36.000 -121.233  317.0 19640715 19970401 690020-93218             325       Monterey
## 13546 690020 99999 JOLON HUNTER LIGGETT MIL RES   US    CA KHGT 36.000 -121.233  317.0 20030702 20030801 690020-99999             325       Monterey
## 13547 690070 93217                FRITZSCHE AAF   US    CA KOAR 36.683 -121.767   43.0 19600404 19930831 690070-93217              32       Monterey
## 13552 690140 93101                 EL TORO MCAS   US    CA KNZJ 33.667 -117.733  116.7 19890101 19990630 690140-93101              95         Orange
## 13553 690150 93121            TWENTY NINE PALMS   US    CA KNXP 34.300 -116.167  625.1 19900102 20190116 690150-93121             617 San Bernardino
## 13554 690150 99999             TWENTYNINE PALMS   US    CA KNXP 34.300 -116.167  626.0 19891115 19891229 690150-99999             617 San Bernardino
##                      geometry
## 13545     POINT (-121.233 36)
## 13546     POINT (-121.233 36)
## 13547 POINT (-121.767 36.683)
## 13552 POINT (-117.733 33.667)
## 13553   POINT (-116.167 34.3)
## 13554   POINT (-116.167 34.3)</code></pre>
<p><br></p>
<p>Now we have only points that fall <em>inside</em> of a CA county, <strong>AND</strong> the new data frame now has a new column/attribute called “<code>name</code>” (all our climate station points have a named CA county associated with them). We could easily specify additional columns inside our <code>st_join</code> function, or if we don’t specify any columns, then all columns from the polygon dataframe that spatially joined/matched the points data would be added to the points dataframe.</p>
<blockquote>
<p><code>isd_ca_co_pts &lt;- st_join(isd_history, left = FALSE, ca_co) # join all columns</code></p>
</blockquote>
<hr>
</div>
</div>
<div id="practice-with-climate-data-example" class="section level2">
<h2>Practice with Climate Data Example!</h2>
<p>Hopefully the above was useful…but let’s actually practice how we may use this by actually using some spatial joins to select and download some climate data from the <code>GSODR</code> package, and then make some visualizations. To start, let’s take a look at what stations have data between 1980 and 2018. Check the <a href="https://ropensci.github.io/GSODR/articles/GSODR.html"><code>GSODR</code></a> vignette for more details, I’m just applying some of the commands they lay describe.</p>
<p><br></p>
<div id="check-stations-for-data-availability" class="section level3">
<h3>Check Stations for Data Availability</h3>
<p>Here we check what stations contain data between a given date range. Some of these stations go back to the 1930’s, but we’ll focus on 1980–2018.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check availability for a date range</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>stations <span class="ot">&lt;-</span> isd_ca_co_pts[isd_ca_co_pts<span class="sc">$</span>BEGIN <span class="sc">&lt;=</span> <span class="dv">19800101</span> <span class="sc">&amp;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>                               isd_ca_co_pts<span class="sc">$</span>END <span class="sc">&gt;=</span> <span class="dv">20181231</span>, ]</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot where these stations are?</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data=</span>ca, <span class="at">fill=</span><span class="st">&quot;steelblue&quot;</span>, <span class="at">alpha=</span><span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data=</span>ca_co, <span class="at">color=</span><span class="st">&quot;gray50&quot;</span>, <span class="at">lwd=</span><span class="fl">0.4</span>, <span class="at">alpha=</span><span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> stations, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">pch=</span><span class="dv">21</span>, <span class="at">color=</span><span class="st">&quot;thistle1&quot;</span>, <span class="at">fill=</span><span class="st">&quot;black&quot;</span>) <span class="sc">+</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;GSOD Stations with data 1980-2018&quot;</span>)</span></code></pre></div>
<p><img src="03_spatial_joins_files/figure-html/checkStations-1.png" width="672" /></p>
<p><br></p>
</div>
<div id="calculate-stations-per-county" class="section level3">
<h3>Calculate Stations Per County</h3>
<p>Looks like there are 53 stations, and some counties have more than one. Let’s apply our spatial join powers to filter this list down a bit. Let’s:</p>
<ul>
<li>Summarize our station data using the spatial_joined county <code>name</code> attribute so we can calculate how many stations we have per county.</li>
<li>Create a dataset that includes only stations from counties with a single station</li>
<li>Create a dataset that contains stations that are within a set distance from the centroid of the county</li>
</ul>
<p>We’ll mainly use some basic <code>dplyr</code> here, which is possible because as <code>sf</code> objects, these are still simple data frames.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">#class(stations) # sf object</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co"># calc number per county</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>stations_n <span class="ot">&lt;-</span> stations <span class="sc">%&gt;%</span> </span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">cnty_name=</span>name) <span class="sc">%&gt;%</span> <span class="co"># make column amore clear</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cnty_name) <span class="sc">%&gt;%</span> </span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n=</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co">#class(stations_n) # still sf object</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="co"># join back to county layer with a spatial join, using left=FALSE (same as &quot;inner_join&quot;)</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>ca_co_stations <span class="ot">&lt;-</span> <span class="fu">st_join</span>(ca_co, stations_n, <span class="at">left =</span> <span class="cn">FALSE</span>)</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="co"># plot!</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data=</span>ca) <span class="sc">+</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data=</span>ca_co_stations, <span class="fu">aes</span>(<span class="at">fill=</span><span class="fu">as.factor</span>(n)), <span class="at">lwd=</span><span class="fl">0.4</span>, <span class="at">alpha=</span><span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_d</span>(<span class="st">&quot;No. of Stations&quot;</span>)<span class="sc">+</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Number of GSOD Stations with data 1980-2018 per County&quot;</span>)</span></code></pre></div>
<p><img src="03_spatial_joins_files/figure-html/Calcpercounty-1.png" width="672" /></p>
<p><br></p>
</div>
<div id="pick-station-nearest-the-centroid-of-county" class="section level3">
<h3>Pick Station Nearest the Centroid of County</h3>
<p>Well great, what do we do for counties with multiple stations? How about picking the station nearest the centroid of the county. Steps:</p>
<ol style="list-style-type: decimal">
<li>We need to work with just counties with more than one station.</li>
<li>We need to add the centroid of each of the counties in question.</li>
<li>We need to select the station nearest the centroid.</li>
</ol>
<p>For <strong>Step 2</strong>, we’re going to use the <code>purrr</code> package to <code>map</code> or <code>apply</code> the <code>st_centroid</code> function over each county in our dataframe. This is the equivalent of a <strong>for-loop</strong>, it just looks very different.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 1: filter to stations with n&gt;1</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>stations_n2 <span class="ot">&lt;-</span> stations_n <span class="sc">%&gt;%</span> <span class="fu">filter</span>(n <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 2: Use &quot;purrr&quot; package with sf to get Centroid points for our counties with n&gt;1</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>ca_co_centroid_pts <span class="ot">&lt;-</span> ca_co_stations <span class="sc">%&gt;%</span> </span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add centroid values using the geometry column</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cent_lon=</span><span class="fu">map_dbl</span>(geometry, <span class="sc">~</span><span class="fu">st_centroid</span>(.x)[[<span class="dv">1</span>]]), </span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">cent_lat=</span><span class="fu">map_dbl</span>(geometry, <span class="sc">~</span><span class="fu">st_centroid</span>(.x)[[<span class="dv">2</span>]])) <span class="sc">%&gt;%</span> </span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="co"># convert to simple dataframe</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="co"># make back into an sf object, but only using the centroid X/Ys we just made</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>ca_co_centroid_pts <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(ca_co_centroid_pts, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;cent_lon&quot;</span>,<span class="st">&quot;cent_lat&quot;</span>), <span class="at">crs=</span><span class="dv">4326</span>, <span class="at">remove =</span> <span class="cn">FALSE</span>)</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="co"># plot!</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data=</span>ca_co) <span class="sc">+</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data=</span>ca_co_centroid_pts, <span class="fu">aes</span>(<span class="at">fill=</span><span class="fu">as.factor</span>(n)), <span class="at">pch=</span><span class="dv">21</span>, <span class="at">size=</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_d</span>(<span class="st">&quot;No. of Stations&quot;</span>) <span class="sc">+</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">&quot;Centroids for Counties with &gt;1 GSOD Station&quot;</span>)</span></code></pre></div>
<p><img src="03_spatial_joins_files/figure-html/filterpercounty-1.png" width="672" /></p>
<blockquote>
<p><strong>Step 3</strong>: This is the trickiest part…</p>
</blockquote>
<p>There are probably a few different ways to do this, but let’s try to use the one that seems simplest and uses the fewest lines of code. A handy package (<code>st_nn</code>) will allows us to nearest neighbors between points/lines/polygons, and can provide distances as well. So let’s get the station nearest our county centroid for all the counties with stations &gt; 1.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nngeo)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co"># find the first nearest neighbor GSOD station for each centroid, returns a list</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>nearest_stations <span class="ot">&lt;-</span> <span class="fu">st_nn</span>(ca_co_centroid_pts, stations_n2, <span class="at">returnDist =</span> T, <span class="at">k =</span> <span class="dv">1</span>, <span class="at">progress =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>## lon-lat points</code></pre>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add distances and centroid ID and make into a dataframe, get only distinct IDs</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>nearest_stations_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">dist=</span>nearest_stations<span class="sc">$</span>dist, <span class="at">centrID=</span><span class="fu">do.call</span>(rbind, nearest_stations<span class="sc">$</span>nn)) <span class="sc">%&gt;%</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">distinct</span>(<span class="at">.keep_all =</span> T)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co"># make a df of stations in counties where n=1</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>stations_n1 <span class="ot">&lt;-</span> stations_n <span class="sc">%&gt;%</span> <span class="fu">filter</span>(n<span class="sc">==</span><span class="dv">1</span>)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="co"># now select the &quot;nearest to centroid&quot; stations and bind to the n1 dataset</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>stations_final <span class="ot">&lt;-</span> stations_n2[nearest_stations_df<span class="sc">$</span>centrID,] <span class="sc">%&gt;%</span> </span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbind</span>(stations_n1)</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot it to be sure</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data=</span>ca_co) <span class="sc">+</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data=</span>ca_co_centroid_pts, <span class="at">pch=</span><span class="dv">21</span>, <span class="at">size=</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data=</span>stations_n2, <span class="at">col=</span><span class="st">&quot;orange&quot;</span>, <span class="at">alpha=</span><span class="fl">0.9</span>, <span class="at">pch=</span><span class="dv">17</span>, <span class="at">size=</span><span class="fl">1.8</span>) <span class="sc">+</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data=</span>stations_final, <span class="at">col=</span><span class="st">&quot;blue3&quot;</span>, <span class="at">alpha=</span><span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Lon&quot;</span>,<span class="at">y=</span><span class="st">&quot;Lat&quot;</span>)<span class="sc">+</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_label_repel</span>(<span class="at">data=</span>stations_final, <span class="fu">aes</span>(<span class="at">x=</span><span class="fu">st_coordinates</span>(geometry)[,<span class="dv">1</span>], </span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">y=</span><span class="fu">st_coordinates</span>(geometry)[,<span class="dv">2</span>], <span class="at">label=</span>CALL), <span class="at">size=</span><span class="fl">2.5</span>) <span class="sc">+</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">caption =</span> <span class="st">&quot;County Centroids (open circle), </span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a><span class="st">Final Stations Selected (blue circle),</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a><span class="st">       Stations n&gt;1 (orange)&quot;</span>)</span></code></pre></div>
<p><img src="03_spatial_joins_files/figure-html/nearestCent-1.png" width="672" /></p>
<p>That was a lot! But Looks like all works, and now we have a final set of stations we can use to download data. For simplicity in this example, I’m picking three stations, one with the lowest elevation, one with the highest elevation, and one with the greatest latitude.</p>
<p><br></p>
</div>
<div id="download-climate-data" class="section level3">
<h3>Download Climate Data</h3>
<p>Now we can use our station list to download daily data for each station for any period of record we want. Note, this code works but took 3-4 minutes to run. To speed things up I’ve saved the file <a href="https://github.com/ryanpeek/mapping-in-R-workshop/raw/master/data/CA_stations_GSOD_19800101-20181231.rda">here</a>, or just grab the summarized data shown in the next section.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get highest and lowest elevation Station IDs and the northernmost (highest) latitude:</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>(stationIDs <span class="ot">&lt;-</span> stations_final <span class="sc">%&gt;%</span> </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">min</span>(ELEV_M)<span class="sc">==</span>ELEV_M <span class="sc">|</span> <span class="fu">max</span>(ELEV_M)<span class="sc">==</span>ELEV_M <span class="sc">|</span> CALL<span class="sc">==</span><span class="st">&quot;KCEC&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(STNID, CALL, <span class="sc">-</span>geometry) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>geometry))</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="co"># get data:</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>climdata <span class="ot">&lt;-</span> <span class="fu">get_GSOD</span>(<span class="at">station =</span> stationIDs<span class="sc">$</span>STNID, <span class="at">years =</span> <span class="fu">c</span>(<span class="dv">1980</span><span class="sc">:</span><span class="dv">2018</span>))</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="co"># save it!!</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(climdata, <span class="at">file =</span> <span class="st">&quot;data/CA_stations_GSOD_19800101-20181231.rda&quot;</span>)</span></code></pre></div>
<hr>
</div>
<div id="summarize-and-visualize" class="section level3">
<h3>Summarize and Visualize!</h3>
<p>Finally, we have data, let’s summarize and visualize these data. I’ll aggregate these data to monthly means so we can see different timing patterns in precipitation and temperature across the state.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">paste0</span>(here<span class="sc">::</span><span class="fu">here</span>(),<span class="st">&quot;/data/CA_stations_GSOD_19800101-20181231.rda&quot;</span>))</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>climdata_stations <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">distinct</span>(climdata, CALL, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords=</span><span class="fu">c</span>(<span class="st">&quot;LON&quot;</span>,<span class="st">&quot;LAT&quot;</span>), <span class="at">crs=</span><span class="dv">4326</span>, <span class="at">remove =</span> F)</span></code></pre></div>
<div id="monthly-average" class="section level4">
<h4>Monthly Average</h4>
<p>Let’s calculate averages and then see how these look for these different stations.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># MONTH: filter missing data out:</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>clim_month <span class="ot">&lt;-</span> climdata <span class="sc">%&gt;%</span> </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(PRCP)) <span class="sc">%&gt;%</span> </span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(CALL, MONTH) <span class="sc">%&gt;%</span> </span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize_at</span>(<span class="at">.vars=</span><span class="fu">c</span>(<span class="st">&quot;TEMP&quot;</span>,<span class="st">&quot;PRCP&quot;</span>), <span class="at">.funs =</span> <span class="fu">list</span>(<span class="at">min=</span>min, <span class="at">mean=</span>mean, <span class="at">max=</span>max)) <span class="sc">%&gt;%</span> </span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CALL=</span>forcats<span class="sc">::</span><span class="fu">fct_relevel</span>(CALL,<span class="fu">c</span>(<span class="st">&quot;KCEC&quot;</span>,<span class="st">&quot;KBLU&quot;</span>,<span class="st">&quot;KTRM&quot;</span>))) <span class="co"># relevel order</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co"># monthly prcp</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>mPPT <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_col</span>(<span class="at">data=</span>clim_month, <span class="fu">aes</span>(<span class="at">x=</span>MONTH, <span class="at">y=</span>PRCP_mean, <span class="at">fill=</span>PRCP_mean), <span class="at">show.legend =</span> T)<span class="sc">+</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">y=</span><span class="st">&quot;&quot;</span>, <span class="at">x=</span><span class="st">&quot;&quot;</span>)<span class="sc">+</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>          <span class="co">#legend.position = &quot;left&quot;,</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.25</span>, <span class="fl">0.55</span>),</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.key.height =</span> <span class="fu">unit</span>(.<span class="dv">15</span>,<span class="at">units =</span> <span class="st">&quot;in&quot;</span>),</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.key.width =</span> <span class="fu">unit</span>(.<span class="dv">1</span>, <span class="at">units =</span> <span class="st">&quot;in&quot;</span>), </span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>          <span class="at">panel.border =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.margin =</span> <span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span> ,<span class="dv">0</span>), <span class="st">&quot;mm&quot;</span>)) <span class="sc">+</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_viridis_c</span>(<span class="st">&quot;Mean </span><span class="sc">\n</span><span class="st">PPT(in)&quot;</span>) <span class="sc">+</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_polar</span>() <span class="sc">+</span> </span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(clim_month<span class="sc">$</span>CALL<span class="sc">~</span>., <span class="at">nrow =</span> <span class="dv">3</span>)</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a><span class="co"># make a map</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>siteMap <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data=</span>ca_co, <span class="at">fill=</span><span class="st">&quot;sienna&quot;</span>,<span class="at">alpha=</span><span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data=</span>climdata_stations, <span class="at">fill=</span><span class="st">&quot;dodgerblue&quot;</span>, <span class="at">alpha=</span><span class="fl">0.9</span>, <span class="at">pch=</span><span class="dv">21</span>, <span class="at">size=</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_label_repel</span>(<span class="at">data=</span>climdata_stations, <span class="fu">aes</span>(<span class="at">x=</span>LON, <span class="at">y=</span>LAT, <span class="at">label=</span>CALL), <span class="at">size=</span><span class="fl">3.7</span>) <span class="sc">+</span></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">panel.border =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">datum =</span> <span class="cn">NA</span>)<span class="sc">+</span></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle=</span><span class="st">&quot;Monthly Precipitation for GSOD Stations, 1980-2018&quot;</span>, <span class="at">y=</span><span class="st">&quot;&quot;</span>,<span class="at">x=</span><span class="st">&quot;&quot;</span>,</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption=</span><span class="st">&quot;Polar plots of monthly precip for each station&quot;</span>)</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot it together using cowplot</span></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a><span class="fu">ggdraw</span>(siteMap) <span class="sc">+</span></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">draw_plot</span>(mPPT, <span class="at">width =</span> <span class="fl">0.6</span>, <span class="at">height =</span> .<span class="dv">53</span>, <span class="at">x =</span> <span class="fl">0.48</span>, <span class="at">y =</span> <span class="fl">0.42</span>)</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">&quot;img/monthly_ppt_map.png&quot;</span>, <span class="at">width =</span> <span class="dv">6</span>, <span class="at">height =</span> <span class="dv">8</span>, <span class="at">units =</span> <span class="st">&quot;in&quot;</span>, <span class="at">dpi=</span><span class="dv">300</span>)</span></code></pre></div>
<p><img src="img/monthly_ppt_map.png" width="100%" height="100%" /></p>
<p><br></p>
</div>
<div id="daily" class="section level4">
<h4>Daily</h4>
<p>Let’s do the same thing for temperature!</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># YDAY: filter</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>clim_day <span class="ot">&lt;-</span> climdata <span class="sc">%&gt;%</span> </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(PRCP)) <span class="sc">%&gt;%</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(CALL, YDAY) <span class="sc">%&gt;%</span> </span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize_at</span>(<span class="at">.vars=</span><span class="fu">vars</span>(TEMP,PRCP), <span class="at">.funs =</span> <span class="fu">list</span>(<span class="at">min=</span>min, <span class="at">mean=</span>mean, <span class="at">max=</span>max))</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co"># daily mean temp</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>(dTEMP <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_col</span>(<span class="at">data=</span>clim_day, <span class="fu">aes</span>(<span class="at">x=</span>YDAY, <span class="at">y=</span>TEMP_mean, <span class="at">fill=</span>TEMP_mean), <span class="at">show.legend =</span> T)<span class="sc">+</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">y=</span><span class="st">&quot;&quot;</span>, <span class="at">x=</span><span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">90</span>, <span class="dv">180</span>, <span class="dv">270</span>),</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>                       <span class="at">labels=</span><span class="fu">c</span>(<span class="st">&quot;Jan&quot;</span>,<span class="st">&quot;Apr&quot;</span>,<span class="st">&quot;Jul&quot;</span>,<span class="st">&quot;Oct&quot;</span>)) <span class="sc">+</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.25</span>, <span class="fl">0.55</span>),</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.key.height =</span> <span class="fu">unit</span>(.<span class="dv">15</span>,<span class="at">units =</span> <span class="st">&quot;in&quot;</span>),</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.key.width =</span> <span class="fu">unit</span>(.<span class="dv">1</span>, <span class="at">units =</span> <span class="st">&quot;in&quot;</span>), </span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>          <span class="at">panel.border =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.margin =</span> <span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span> ,<span class="dv">0</span>), <span class="st">&quot;mm&quot;</span>)) <span class="sc">+</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_viridis_c</span>(<span class="st">&quot;Mean </span><span class="sc">\n</span><span class="st">Temp(C)&quot;</span>) <span class="sc">+</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_polar</span>() <span class="sc">+</span> </span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(CALL<span class="sc">~</span>., <span class="at">nrow =</span> <span class="dv">3</span>))</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>siteMap2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data=</span>ca_co, <span class="at">fill=</span><span class="st">&quot;sienna&quot;</span>,<span class="at">alpha=</span><span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data=</span>climdata_stations, <span class="at">fill=</span><span class="st">&quot;dodgerblue&quot;</span>, <span class="at">alpha=</span><span class="fl">0.9</span>, <span class="at">pch=</span><span class="dv">21</span>, <span class="at">size=</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_label_repel</span>(<span class="at">data=</span>climdata_stations, <span class="fu">aes</span>(<span class="at">x=</span>LON, <span class="at">y=</span>LAT, <span class="at">label=</span>CALL), <span class="at">size=</span><span class="fl">3.7</span>) <span class="sc">+</span></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">panel.border =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">datum =</span> <span class="cn">NA</span>)<span class="sc">+</span></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle=</span><span class="st">&quot;Daily Mean Temperature for GSOD Stations, 1980-2018&quot;</span>, <span class="at">y=</span><span class="st">&quot;&quot;</span>,<span class="at">x=</span><span class="st">&quot;&quot;</span>,</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption=</span><span class="st">&quot;Polar plots of daily temp for each station&quot;</span>)</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot it together using cowplot</span></span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a><span class="fu">ggdraw</span>(siteMap2) <span class="sc">+</span></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">draw_plot</span>(dTEMP, <span class="at">width =</span> <span class="fl">0.63</span>, <span class="at">height =</span> .<span class="dv">53</span>, <span class="at">x =</span> <span class="fl">0.48</span>, <span class="at">y =</span> <span class="fl">0.42</span>)</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">&quot;img/daily_temp_map.png&quot;</span>, <span class="at">width =</span> <span class="dv">6</span>, <span class="at">height =</span> <span class="dv">8</span>, <span class="at">units =</span> <span class="st">&quot;in&quot;</span>, <span class="at">dpi=</span><span class="dv">300</span>)</span></code></pre></div>
<p><img src="img/daily_temp_map.png" width="100%" height="100%" /></p>
</div>
</div>
<div id="summary" class="section level3">
<h3>Summary</h3>
<p>California is an interesting place because we get most of our water during the winter, and typically have a long warm/dry period through the summer (a common Mediterranean climate pattern). It’s also striking to see the difference in mean precipitation (over a ~40 year period) across the state.</p>
<p>Hopefully there were some useful tidbits in this lesson/post. Please let me know if you have questions/comments (see the Contact tab).</p>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = false;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
